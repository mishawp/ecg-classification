# Предобработка данных

- `download_data.py` - скачивание из интернета данных;
- `processing1d.py` - функции для 1D обработки сигнала;
- `processing1d.py` - функции для 2D обработка сигнала;
- `make_dataset.py` - обрабатывает данные, используя `processing1d.py` или `processing2d.py`

## 1D обработка

1. Мы будем использовать данные с частотой дискретизации **100 Гц**, поскольку частота 90 Гц была признано минимальной для выявления форм волны в сигнале (P, QRS и T) [[1](#1)];
2. Будем использовать только сигналы трех отведений: **I, II, V2**. Использование всех 12 отведений потребовало бы больших вычислительных ресурсов. Исходя из [[2](#2)] по данным этих трех отведений были успешно реконструированы 12 отведений. Следовательно, они содержат большую часть релевантной информации из всех каналов;
3. Применим полосовой фильтр Баттерворта второго порядка с частотой среза верхних частот 1 Гц для подавления блуждания базовой линии и частотой среза низких частот 45 Гц для устранения высокочастотных шумов [[3-5](#3)];
4. Применим z-нормализация, для уменьшения влияния выбросов;

## 2D обработка

2D обработка заключается в преобразовании 1D представления в изображение, как это было сделано в [[8](#8)]. Чтобы сохранить корреляционную зависимость между сэмплами, применяются Gramian Angular Field (GAF), Recurrence Plot (RP) и Markov Transition Field (MTF). Автор статьи [[8](#8)], что эти преобразования лучше, по сравнению с другими преобразованиями, такими как короткопериодное преобразование Фурье или вейвлет-преобразование.

1. Во-первых, используем все те же три отведения **I, II, V2** с частотой дискретизации **100 Гц** и тот же полосовой фильтр Баттерворта, что и при 1D обработке (пункты 1-3 1D обработки);
2. Нормализуем сигнал, так, чтобы все значения были в интервале от \[0:1\];
3. Для каждого из трех отведений мы создаем по три изображения размерностью (1000, 1000) (итого 3x3). Объединив их получим одно изображения размерностью (9, 1000, 1000).
4. Вышеупомянутые три изображения получаем, используя Gramian Angular Field (GAF), Recurrence Plot (RP) и Markov Transition Field (MTF), согласно статье [[8](#8)]:
5. Уменьшения размера изображения методом интерполяции (или уменьшение размера входного 1D сигнала)

*GAF* - это изображение, полученное из временного ряда, представляющее собой некую временную корреляцию между каждой парой значений временного ряда. Представляет изображение в угловой системе, взамен простой прямоугольной.
Пусть $E$ - сигнал ЭКГ из $n$ значений (samples), такое, что $E=\{s_1, s_2, ..., s_n\}$. Нормализовав $E$ получим $\overline{E}$. Нормализованную ЭКГ можно отобразить на угловую систему следующим образом: значения сигнала преобразуем в угловые значения (angular cos) через $arccos$, а временную метку - в радиус.

$$\begin{align*} \left.{\begin{array}{ccc} \beta = arccos(s_{i0}) \\ R = \dfrac {t_i}{C}\end{array}}\right \},\tag{1}\end{align*}$$

где $s_{i0}$ - нормализованное значение сигнала; $t_i$ - временная метка для $s_{i0}$; $i=\{1, 2, ..., n\}$; $C$ - константа, регулирующая радиус.

Чтобы наилучшим образом показать корреляцию между двумя значениями разных временных меток, используются два метода: суммирования и разности. В данной работе используется метод суммирования, который имеет вид:

$$\begin{align*} Grammian\,field=&cos(\beta _{i} + \beta _{j}); \tag{2}\\ Grammian\, field=&\overline {E}^{T}. \overline {E} - {\sqrt {I - \overline {E}^{2}}}^{T}. \sqrt {I - {\overline {E}}^{2}},\tag{3}\end{align*}$$

где $i, j=\{1, 2, ..., n\}$, $I$ - единичный вектор (unit row vector).

*RP* - это изображение, представляющее расстояние между траекториями (временными точками), извлеченными из исходного временного ряда

$$\begin{equation*} \text {R-plot} = \alpha (\lambda - ||s_i - s_j||),\tag{4}\end{equation*}$$

где $\lambda$ - предельное значение; $i, j=\{1, 2, ..., n\}$, $\alpha$ - функция Хевисайда, которая имеет вид

$$\begin{equation*} \alpha(x) = \begin{cases} 
0, & x < 0; \\
1, & x \ge 0.
\end{cases}\end{equation*}$$

*MTF* - это изображение, полученное из временного ряда, представляющее собой поле вероятностей перехода для дискретизированного временного ряда. Он показывает, насколько связаны между собой две произвольные значения временного ряда, относительно того, как часто они появляются рядом друг с другом во временном ряду.

Первый шаг преобразования - разложение каждого значения временного ряда по квантилям (или бинам). Например, если у нас есть временной ряд с непрерывными значениями от 0 до 1, и мы задаем квантиль, равный 10, то значения ряда будут распределены по 10 интервалам (например, 0-0.1, 0.1-0.2, ..., 0.9-1.0).

Далее формируется матрица переходов состояний:
$$A_{ij}=P(s_t=j|s_{t-1}=i)$$
Т.е. $A_{ij}$ - это вероятность перехода из состояния *i* в состояние *j*. Оцениваем это значение методом максимального правдоподобия: $A_{ij}$ равно отношению количества переходов из *i* в *j* на общее число раз, когда мы находились в состоянии *i*.

Заметим, что если у нас *Q* квантилей, то $A$ - это матрица $Q \times Q$.

Эта матрица учитывает только вероятности переходов между бинами, независимо от времени, и это приводит к потере информации о пространственных характеристиках сигнала. Для устранения этого недостатка матрицу $A$ преобразуют в марковское поле переходов $M$:

$$ M_{kl}=A_{q_k q_l},$$

где $q_k$ - квантиль для $x_k$; $q_l$ - квантиль для $x_l$. Индексы при $A$ относятся к состояниями, а индексы при $M$ - к временным меткам.

$A_{ij}$ - вероятность перехода из состояния $i$ в состояние $j$.

$M_{kl}$ - вероятность одноступенчатого (one-step) перехода из бина для $x_k$ в бин для $x_l$. Т.е. $x_k$ и $x_l$ рассматриваются как две точки в временном ряде в произвольные моменты времени $k$ и $l$.

$q_k$ и $q_l$ - соответствующие квантили.

$M_{kl}$ - это вероятность прямого одноступенчатого (direct one-step) (т.е. марковского) перехода от $q_k$ к $q_l$ во временном ряду [[9](#9)].

## Метки

1. Добавим к каждой метке информацию о том, к какому классу (поле `diagnostic_class` в `scp_statements.csv`) относится диагноз (напр., диагнозы *NDT, NST_, DIG, LNGQT* относятся к классу *STTC*). По этим классам и будет происходить классификация.
2. Представим метку (меткой является `diagnostic_class`) как бинарный вектор из 4 элементов. Комбинации нулей и единиц в этом векторе будет соответствовать класс(-у) диагноза(-ов). Таблица соответствия

    | diagnostic_class\index | 0 | 1 | 2 | 3 |
    | --- | --- | --- | --- | --- |
    | NORM | 0 | 0 | 0 | 0 |
    | MI | 1 | 0 | 0 | 0 |
    | STTC | 0 | 1 | 0 | 0 |
    | CD | 0 | 0 | 1 | 0 |
    | HYP | 0 | 0 | 0 | 1 |

    Пример комбинаций классов:
    | diagnostic_class\index | 0 | 1 | 2 | 3 |
    | --- | --- | --- | --- | --- |
    | MI & HYP | 1 | 0 | 0 | 1 |
    | STTC & CD & HYP | 0 | 1 | 1 | 1 |
    | ... | ... | ... | ... | ... |

## Разделение на тренировочную, валидационную и тестовую наборы

Разделим записи на обучающий, валидационный и тестовый наборы согласно предложенному самим поставщиком данных разбиению [[6](#6)] (см. также [[7](#7)]). Каждая запись относится к 1 из 10 складок (fold) (поле `strat_fold` в файле `ptbxl-database.csv`). Рекомендуется записи, относящиеся к 1-8 складкам, использовать в качестве обучающего набора; записи, относящиеся к 9-ой складке - в качестве валидационного набора; записи, относящиеся к 10-ой складке - в качестве тестового.

## Список литературы

1. <a id='1'></a> [N.T. Bui, G.S. Byun, The comparison features of ECG signal with different sampling frequencies and filter methods for real-time measurement, Symmetry (ISSN: 20738994) 13 (2021)](https://www.mdpi.com/2073-8994/13/8/1461).
2. <a id='2'></a> [H. Zhu, Y. Pan, K.T. Cheng, R. Huan, A lightweight piecewise linear synthesis method for standard 12-lead ECG signals based on adaptive region segmentation, PLoS One (ISSN: 1932-6203) 13 (2018) e0206170](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0206170)
3. <a id='3'></a> [H.Z. Li, P. Boulanger, A Survey of Heart Anomaly Detection Using Ambulatory Electrocardiogram (ECG), Sensors (Basel, Switzerland) (ISSN: 14248220) 20 (2020)](https://www.mdpi.com/1424-8220/20/5/1461).
4. <a id='4'></a> [K.N. Rajesh, R. Dhuli, Classification of ECG heartbeats using nonlinear decomposition methods and support vector machine, Comput. Biol. Med. (ISSN: 1879-0534) 87 (2017) 271–284](https://www.sciencedirect.com/science/article/abs/pii/S0010482517301701?via%3Dihub).
5. <a id='5'></a> [H. Sivaraks, C.A. Ratanamahatana, Robust and accurate anomaly detection in ECG artifacts using time series motif discovery, Comput. Math. Methods Med. (ISSN: 17486718) 2015 (2015)](https://www.hindawi.com/journals/cmmm/2015/453214/).
6. <a id='6'></a> [PTB-XL, a large publicly available electrocardiography dataset](https://physionet.org/content/ptb-xl/1.0.3/).
7. <a id='7'></a> [P. Wagner, N. Strodthoff, R.-D. Bousseljot, D. Kreiseler, F.I. Lunze, W. Samek, T. Schaeffter, PTB-XL, A large publicly available electrocardiography dataset, Sci. Data 7 (154) (2020)](https://www.nature.com/articles/s41597-020-0495-6).
8. <a id='8'></a> [Z. Ahmad, A. Tabassum, L. Guan, N.M. Khan, ECG heartbeat classification using multimodal fusion, IEEE Access 9 (2021)](https://ieeexplore.ieee.org/document/9486862)
9. <a id='9'></a> [Convert a Time Series Into an Image with Gramian Angular Fields and Markov Transition Fields [Электронный ресурс]: Lazy Programmer.](https://lazyprogrammer.me/convert-a-time-series-into-an-image/)